<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap" rel="stylesheet">

    <title>영화어때?</title>

    <style>
        * {
            font-family: 'Gowun Batang', serif;
            color: black;
        }

        #wrap {
            width: 95%;
            max-width: 300px;
            margin: 10px auto;
        }

        #inputForm > * {
            margin-top: 10px;
        }

        a {
            text-decoration-line: none;
        }
    </style>
    <script>
    $(function(){
        Kakao.init('03c25a5a3c2250061760a2a4c5d5b6b8');
    })

        function createHiddenLoginForm(kakaoId) {
            $.ajax({
                type: "POST",
                url: "/member/kakaologin",
                data: {
                    id_give: kakaoId
                },
                success: function (response) {
                    if (response['result'] == 'success') {
                        $.cookie('mytoken', response['token'], { expires: 1, path: '/' });
                        alert('로그인 되었습니다.')
                        window.location.href = '/'
                    } else {
                        alert(response['msg'])
                    }
                }
            })
        }

        function kakaoLogin() {

            Kakao.Auth.login({
                success: function (response) {
                    Kakao.API.request({ // 사용자 정보 가져오기
                        url: '/v2/user/me',
                        success: (response) => {
                            console.log(response);
                            var kakaoid = response.id + "K";
                            var nikename = response.properties.nickname;
                            $.ajax({
                                type: "post",
                                url: '/member/idDuplicateCheck',
                                data: {"id_give": kakaoid},
                                dataType: "json",
                                success: function (response) {

                                    if (response['idExists'] == true) {
                                        // 존재하는 경우 로그인 처리
                                        createHiddenLoginForm(kakaoid);

                                    } else {
                                        // 회원가입
                                        $.ajax({
                                            type: "post",
                                            url: '/member/kakaoJoin',
                                            data: {
                                                "id_give": kakaoid,
                                                "nickname_give": nikename
                                            },
                                            dataType: "json",
                                            success: function (response) {
                                                if (response['result'] == 'success') {
                                                    // 로그인
                                                    createHiddenLoginForm(kakaoid);
                                                } else {
                                                    alert('카카오 회원가입 실패. 일반계정으로 로그인하시기 바랍니다.');
                                                }
                                            },
                                            error: function (request, status, error) {
                                                alert("code: " + request.status + "\n" + "message: " + request.responseText + "\n" + "error: " + error);
                                            }
                                        });
                                    }
                                },
                                error: function (request, status, error) {
                                    alert("code: " + request.status + "\n" + "message: " + request.responseText + "\n" + "error: " + error);
                                }
                            });
                        }
                    });
                    // window.location.href='/ex/kakao_login.html' //리다이렉트 되는 코드
                },
                fail: function (error) {
                    alert(error);
                }
            });
        }

        function login() {
            $.ajax({
                type: "POST",
                url: "/member/login",
                data: {
                    id_give: $('#memberId').val(),
                    pw_give: $('#memberPw').val(),
                },
                success: function (response) {
                    if (response['result'] == 'success') {
                        $.cookie('mytoken', response['token']);
                        alert('로그인 되었습니다.')
                        window.location.href = '/'
                    } else {
                        alert(response['msg'])
                    }
                }
            })
        }
    </script>
</head>
<body>
<div id="wrap">
    <div>
        <div class="mb-3" id="inputForm">
            <input type="text" class="form-control" id="memberId" placeholder="아이디">
            <input type="password" class="form-control" id="memberPw" placeholder="비밀번호">
            <div class="d-grid gap-2">
                <button class="btn btn-danger" type="button" onclick="login()">로 그 인</button>
            </div>
        </div>
        <div>
            <a href="/member/changePwPage"><span>비밀번호 재설정</span></a>
            <a href="/member/joinPage" style="float: right;"><span>회원가입</span></a></div>
    </div>
    <a href="javascript:void(0);" onclick="kakaoLogin()" target="_blank"><img src="/static/kakao_login_medium_wide.png"></a>
</div>
</div>
</body>
</html>